#!/usr/bin/env bash

set -e -u -x

# Clean files that may be left over if container doesn't shut down cleanly.
rm -f /tmp/.s.PGSQL.*

# Clean files that are tailed by fluent-bit when using console output to prevent
# lots of output from previous logs on startup.
rm -f /var/log/api-umbrella/trafficserver/error.log

make

# Wait for PostgreSQL to be ready before running database setup.
echo "Waiting for PostgreSQL to be ready..."
until PGPASSWORD=dev_password psql -h postgres -U postgres -c '\q' 2>/dev/null; do
  echo "PostgreSQL is unavailable - sleeping"
  sleep 1
done
echo "PostgreSQL is ready"

# Run database setup as postgres superuser to create the database and roles.
# This is idempotent and safe to run on every startup.
DB_USERNAME=postgres DB_PASSWORD=dev_password api-umbrella db-setup

api-umbrella run
